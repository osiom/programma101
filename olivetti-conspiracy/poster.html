<!DOCTYPE html>
<html>
<head>
  <title>Isometric Cubes - Telegram Updates</title>
  <style>
  body {
      margin: 0;
      padding: 0;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      background-color: #f0ead6; /* Cream background like Olivetti poster */
      position: relative;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
  }

  .updates-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      background: transparent;
      z-index: 2;
  }

  .cube-container {
      position: absolute;
      pointer-events: all;
      cursor: pointer;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.6s cubic-bezier(0.23, 1, 0.320, 1);
      z-index: 9999;
  }

  .cube-container.show {
      opacity: 1;
      transform: scale(1);
  }

  .cube-container.fade-out {
      opacity: 0;
      transform: scale(0.8);
  }

  .cube-container:hover {
      transform: scale(1.05);
  }

  .cube {
    width: 120px;
    height: 120px;
    position: relative;
    transform-style: preserve-3d;
    transform: rotateX(-15deg) rotateY(30deg);
    transition: transform 0.3s ease;
  }

  .cube-face {
    position: absolute;
    width: 120px;
    height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 8px;
    font-weight: 500;
    text-align: center;
    padding: 6px;
    box-sizing: border-box;
    line-height: 1.1;
    letter-spacing: 0.3px;
    overflow: hidden;
    word-wrap: break-word;
    hyphens: auto;
    border: 0px solid #333; /* Visible lines for all faces */
  }

  .front { transform: translateZ(60px); }
  .back { transform: rotateY(180deg) translateZ(60px); }
  .right { transform: rotateY(90deg) translateZ(60px); }
  .left { transform: rotateY(-90deg) translateZ(60px); }
  .top { transform: rotateX(90deg) translateZ(60px); }
  .bottom { transform: rotateX(-90deg) translateZ(60px); }

  /* Default white for all faces */
  .cube-face {
    background: transparent;
    color: #333;
  }

  /* Color both FRONT and TOP faces */
  .cube-red .front { background: #e74c3c; color: white; border: 1px solid #c0392b; }
  .cube-red .top { background: #d62c1a; color: white; border: 1px solid #c0392b; }

  .cube-blue .front { background: #3498db; color: white; border: 1px solid #2980b9; }
  .cube-blue .top { background: #5dade2; color: white; border: 1px solid #2980b9; }

  .cube-yellow .front { background: #f1c40f; color: #2c3e50; border: 1px solid #f39c12; }
  .cube-yellow .top { background: #f7dc6f; color: #2c3e50; border: 1px solid #f39c12; }

  .cube-purple .front { background: #9b59b6; color: white; border: 1px solid #8e44ad; }
  .cube-purple .top { background: #bb8fce; color: white; border: 1px solid #8e44ad; }

  .cube-teal .front { background: #1abc9c; color: white; border: 1px solid #16a085; }
  .cube-teal .top { background: #76d7c4; color: white; border: 1px solid #16a085; }

  .cube-orange .front { background: #e67e22; color: white; border: 1px solid #d35400; }
  .cube-orange .top { background: #f8c471; color: white; border: 1px solid #d35400; }

  .cube-green .front { background: #27ae60; color: white; border: 1px solid #229954; }
  .cube-green .top { background: #58d68d; color: white; border: 1px solid #229954; }

  .close-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    background: rgba(0,0,0,0.7);
    border: none;
    color: #ffebae;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 10px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    transition: all 0.2s ease;
  }

  .close-btn:hover {
    background: rgba(0,0,0,0.9);
    transform: scale(1.1);
  }

  .loading-indicator {
    position: fixed;
    top: 30px;
    right: 30px;
    background: rgba(44, 62, 80, 0.9);
    color: #ffebae;
    padding: 10px 15px;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    z-index: 2000;
    opacity: 0;
    transition: all 0.3s ease;
  }

  .loading-indicator.show {
    opacity: 1;
  }
  </style>
</head>
<body>
  <!-- Add this SVG to your poster.html body, right after the opening <body> tag -->
  <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg" style="position: absolute; top: 0; left: 0; z-index: 1; pointer-events: none;">
    <defs>
      <pattern id="isometricHangingGrid" x="0" y="0" width="120" height="104" patternUnits="userSpaceOnUse">
        <!-- Horizontal lines (left to right) -->
        <line x1="0" y1="0" x2="120" y2="0" stroke="#d0c8b8" stroke-width="0.8" opacity="0.6"/>
        <line x1="0" y1="26" x2="120" y2="26" stroke="#d0c8b8" stroke-width="0.8" opacity="0.6"/>
        <line x1="0" y1="52" x2="120" y2="52" stroke="#d0c8b8" stroke-width="0.8" opacity="0.6"/>
        <line x1="0" y1="78" x2="120" y2="78" stroke="#d0c8b8" stroke-width="0.8" opacity="0.6"/>
        <line x1="0" y1="104" x2="120" y2="104" stroke="#d0c8b8" stroke-width="0.8" opacity="0.6"/>
        
        <!-- Diagonal lines (left bottom to top right) - matching cube angle -->
        <line x1="0" y1="104" x2="60" y2="52" stroke="#d0c8b8" stroke-width="0.8" opacity="0.6"/>
        <line x1="60" y1="104" x2="120" y2="52" stroke="#d0c8b8" stroke-width="0.8" opacity="0.6"/>
        <line x1="30" y1="104" x2="90" y2="52" stroke="#d0c8b8" stroke-width="0.8" opacity="0.6"/>
        <line x1="90" y1="104" x2="150" y2="52" stroke="#d0c8b8" stroke-width="0.8" opacity="0.6"/>
        
        <!-- Additional diagonal lines for density -->
        <line x1="0" y1="78" x2="60" y2="26" stroke="#d0c8b8" stroke-width="0.8" opacity="0.6"/>
        <line x1="60" y1="78" x2="120" y2="26" stroke="#d0c8b8" stroke-width="0.8" opacity="0.6"/>
        <line x1="30" y1="78" x2="90" y2="26" stroke="#d0c8b8" stroke-width="0.8" opacity="0.6"/>
        
        <line x1="0" y1="52" x2="60" y2="0" stroke="#d0c8b8" stroke-width="0.8" opacity="0.6"/>
        <line x1="60" y1="52" x2="120" y2="0" stroke="#d0c8b8" stroke-width="0.8" opacity="0.6"/>
        <line x1="30" y1="52" x2="90" y2="0" stroke="#d0c8b8" stroke-width="0.8" opacity="0.6"/>
      </pattern>
    </defs>
    
    <rect width="100%" height="100%" fill="url(#isometricHangingGrid)"/>
  </svg>
  <div class="loading-indicator" id="loading-indicator">Loading Updates</div>
  <div class="updates-container" id="updates-container"></div>

  <script>
    const CHANNEL_USERNAME = "sorridianupdates";
    
    const CONFIG = {
      maxSimultaneousUpdates: 15,
      updateLifetime: 20000,
      timeBetweenUpdates: 1500,
    };

    let allUpdates = [];
    let activeCubes = [];
    let updateIndex = 0;
    let isLoading = false;

    // More spaced out grid - increased spacing between cubes
    const positions = [
      // Much more spacing - 12% between columns, 10% between rows
      { top: '15%', left: '5%', column: 0 }, { top: '15%', left: '17%', column: 1 }, { top: '15%', left: '29%', column: 2 }, { top: '15%', left: '41%', column: 3 },
      { top: '25%', left: '5%', column: 0 }, { top: '25%', left: '17%', column: 1 }, { top: '25%', left: '29%', column: 2 }, { top: '25%', left: '41%', column: 4 },
      { top: '35%', left: '5%', column: 0 }, { top: '35%', left: '17%', column: 1 }, { top: '35%', left: '29%', column: 2 }, { top: '35%', left: '41%', column: 3 },
      { top: '45%', left: '5%', column: 0 }, { top: '45%', left: '17%', column: 1 }, { top: '45%', left: '29%', column: 2 }, { top: '45%', left: '41%', column: 4 },
      { top: '55%', left: '5%', column: 0 }, { top: '55%', left: '17%', column: 1 }, { top: '55%', left: '29%', column: 2 }, { top: '55%', left: '41%', column: 3 },
      { top: '65%', left: '5%', column: 0 }, { top: '65%', left: '17%', column: 1 }, { top: '65%', left: '29%', column: 2 }, { top: '65%', left: '41%', column: 4 },
      { top: '75%', left: '5%', column: 0 }, { top: '75%', left: '17%', column: 1 }, { top: '75%', left: '29%', column: 2 }, { top: '75%', left: '41%', column: 3 },
    ];

    // Column color mapping
    const columnColors = [
      'cube-blue',     // Column 0
      'cube-red',      // Column 1
      'cube-yellow',   // Column 2
      'cube-purple',   // Column 3
      'cube-teal'      // Column 4
    ];

    function showLoading() {
      isLoading = true;
      document.getElementById('loading-indicator').classList.add('show');
    }

    function hideLoading() {
      isLoading = false;
      document.getElementById('loading-indicator').classList.remove('show');
    }

    function getRandomPosition() {
      const usedPositions = activeCubes.map(cube => cube.position);
      const availablePositions = positions.filter(pos => 
        !usedPositions.some(used => 
          Math.abs(parseFloat(used.top) - parseFloat(pos.top)) < 8 && // Increased from 3 to 8
          Math.abs(parseFloat(used.left) - parseFloat(pos.left)) < 10  // Increased from 3 to 10
        )
      );
      
      return availablePositions.length === 0 ? 
        positions[Math.floor(Math.random() * positions.length)] :
        availablePositions[Math.floor(Math.random() * availablePositions.length)];
    }

    function createCube(update, position) {
      const container = document.createElement('div');
      const colorClass = columnColors[position.column];
      
      container.className = `cube-container ${colorClass}`;
      container.style.zIndex = '9999';
      container.style.top = position.top;
      container.style.left = position.left;

      const content = update.text.length > 30 ? 
        update.text.substring(0, 27) + '...' : 
        update.text;

      container.innerHTML = `
        <button class="close-btn" onclick="removeCube(this.parentElement)">Ã—</button>
        <div class="cube">
          <div class="cube-face front">${content}</div>
          <div class="cube-face back"></div>
          <div class="cube-face right"></div>
          <div class="cube-face left"></div>
          <div class="cube-face top"></div>
          <div class="cube-face bottom"></div>
        </div>
      `;

      document.getElementById('updates-container').appendChild(container);

      setTimeout(() => {
          container.classList.add('show');
      }, 100);

      const removeTimeout = setTimeout(() => {
        removeCube(container);
      }, CONFIG.updateLifetime);

      const cubeData = {
        element: container,
        position: position,
        timeout: removeTimeout
      };
      
      activeCubes.push(cubeData);
      return cubeData;
    }

    function removeCube(cubeElement) {
      const cubeData = activeCubes.find(c => c.element === cubeElement);
      if (!cubeData) return;

      clearTimeout(cubeData.timeout);
      activeCubes = activeCubes.filter(c => c !== cubeData);

      cubeElement.classList.add('fade-out');
      
      setTimeout(() => {
        if (cubeElement.parentElement) {
          cubeElement.parentElement.removeChild(cubeElement);
        }
      }, 600);
    }

    function showNextCube() {
      if (isLoading || allUpdates.length === 0 || activeCubes.length >= CONFIG.maxSimultaneousUpdates) {
        return;
      }
      const update = allUpdates[updateIndex % allUpdates.length];
      updateIndex++;
      const position = getRandomPosition();
      createCube(update, position);
    }

    async function fetchTelegramPosts() {
      try {
        showLoading();
        const proxies = [
          'https://api.allorigins.win/raw?url=',
          'https://cors-anywhere.herokuapp.com/',
          'https://corsproxy.io/?'
        ];
        
        const telegramPublicUrl = `https://t.me/s/${CHANNEL_USERNAME}`;
        let html = null;
        
        for (const proxy of proxies) {
          try {
            const finalUrl = proxy.includes('?url=') 
              ? proxy + encodeURIComponent(telegramPublicUrl)
              : proxy + telegramPublicUrl;
              
            const response = await fetch(finalUrl);
            
            if (response.ok) {
              html = await response.text();
              break;
            }
          } catch (proxyError) {}
        }
        
        if (!html) {
          throw new Error("All proxies failed");
        }
        
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const selectors = [
          '.tgme_widget_message_text', 
          '.tgme_widget_message_bubble', 
          '.js-message_text'
        ];
        
        let messageElements = [];
        
        for (const selector of selectors) {
          const elements = doc.querySelectorAll(selector);
          if (elements && elements.length > 0) {
            messageElements = elements;
            break;
          }
        }
        
        if (messageElements.length > 0) {
          const messages = Array.from(messageElements)
            .map(element => ({ text: element.textContent.trim() }))
            .filter(msg => {
              if (!msg.text) return false;
              
              const adminMessages = [
                "channel created", "invited by", "joined the channel",
                "changed the channel", "changed channel", "pinned a message",
                "changed the chat photo", "changed the group photo",
                "the group was renamed", "the channel was renamed",
                "changed group name", "changed channel name",
                "added a new admin", "removed an admin",
                "added admin", "removed admin",
                "created the group", "created the channel"
              ];
              const lowerCaseText = msg.text.toLowerCase();
              return !adminMessages.some(phrase => lowerCaseText.includes(phrase.toLowerCase()));
            })
            .slice(0, 10);
          
          if (messages.length > 0) {
            allUpdates = messages;
          } else {
            allUpdates = [
              { text: "Welcome to our updates!" },
              { text: "Follow @" + CHANNEL_USERNAME },
              { text: "Latest news coming soon" }
            ];
          }
        } else {
          allUpdates = [
            { text: "Welcome to our updates!" },
            { text: "Follow @" + CHANNEL_USERNAME },
            { text: "Latest news coming soon" }
          ];
        }
        
        hideLoading();
      } catch (error) {
        allUpdates = [
          { text: "Updates loading..." },
          { text: "Check back soon!" },
          { text: "Follow @" + CHANNEL_USERNAME }
        ];
        hideLoading();
      }
    }

    function startCubeDisplay() {
      if (allUpdates.length > 0) {
        showNextCube();
      }
      setInterval(showNextCube, CONFIG.timeBetweenUpdates);
    }

    window.removeCube = removeCube;

    async function init() {
      await fetchTelegramPosts();
      startCubeDisplay();
      setInterval(fetchTelegramPosts, 300000);
    }

    init();
  </script>
</body>
</html>